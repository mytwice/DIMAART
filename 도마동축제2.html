<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>공연, 전시일 때</title>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f0f0f0;
        }

        .top-nav {
            background-color: #e6e6e6;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .content-wrapper {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .navigation-links {
            display: flex;
            gap: 10px;
            align-items: center;
            color: #666;
            margin-bottom: 20px;
        }

        .performance-block {
            display: flex;
            gap: 20px;
            background: #fff;
            padding: 20px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .poster-container {
            width: 180px;
            height: 240px;
            background: #fff;
            border: 1px solid #ddd;
        }

        .poster-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .info-container {
            flex: 1;
        }

        .info-container h1 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 24px;
        }

        .info-table {
            width: 100%;
            border-collapse: collapse;
        }

        .info-table td {
            padding: 8px 0;
            color: #666;
        }

        .info-table td:first-child {
            width: 100px;
            color: #333;
            font-weight: bold;
        }

        .d-day-container {
            text-align: right;
            margin: 20px 0;
        }

        .d-day {
            display: inline-block;
            background: #fff;
            padding: 10px 20px;
            border-radius: 4px;
            font-weight: bold;
            color: #333;
        }

        .status-container {
            display: flex;
            justify-content: space-between;
            background: #fff;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-circle {
            width: 20px;
            height: 20px;
            border: 2px solid #666;
            border-radius: 50%;
        }

        .status-active {
            background-color: #666;
        }

        .notice-block {
            background: #fff;
            padding: 20px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .notice-block h2 {
            margin: 0 0 15px 0;
            color: #333;
        }

        .team-info {
            background: #fff;
            padding: 20px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .cardnews-container {
            background: #fff;
            padding: 20px;
            border-radius: 4px;
            margin-bottom: 20px;
            text-align: center;
        }

        .cardnews-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }

        .bottom-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }

        .btn {
            padding: 10px 30px;
            border: none;
            border-radius: 4px;
            background: #666;
            color: #fff;
            cursor: pointer;
            font-size: 16px;
        }

        .btn:hover {
            background: #555;
        }

        @media (max-width: 768px) {
            .performance-block {
                flex-direction: column;
            }

            .poster-container {
                width: 100%;
                max-width: 240px;
                margin: 0 auto;
            }
        }
    </style>
</head>
<body>
    <div class="top-nav">
        <a href="https://mytwice.github.io/DIMAART/" style="text-decoration: none; color: #333;">← DIMA ARTIST</a>
        <div>
            <button class="btn" onclick="location.href='https://mytwice.github.io/DIMAART/'">공유하기</button>
            <button class="btn">신청하기</button>
        </div>
    </div>

    <div class="content-wrapper">
        <div class="navigation-links">
            <span>기존에 그대로 상담고정해서 따라오게 ></span>
        </div>

        <div class="performance-block">
            <div class="poster-container">
                <img id="mainPoster" alt="공연 포스터">
            </div>
            <div class="info-container">
                <h1 id="showTitle"></h1>
                <table class="info-table">
                    <tr>
                        <td>시간</td>
                        <td id="showDate"></td>
                    </tr>
                    <tr>
                        <td>장소</td>
                        <td id="showVenue"></td>
                    </tr>
                    <tr>
                        <td>출연</td>
                        <td id="showCast"></td>
                    </tr>
                    <tr>
                        <td>주최/주관</td>
                        <td id="showOrganizer"></td>
                    </tr>
                </table>
            </div>
        </div>

        <div class="d-day-container">
            <div class="d-day" id="dDay"></div>
        </div>

        <div class="status-container">
            <div class="status-item">
                <div id="statusEntry" class="status-circle"></div>
                <span>사전예매/현장예매</span>
            </div>
            <div class="status-item">
                <div id="statusTime" class="status-circle"></div>
                <span>15분전</span>
            </div>
            <div class="status-item">
                <div id="statusNotice" class="status-circle"></div>
                <span>관람유의</span>
            </div>
            <div class="status-item">
                <div id="statusPhoto" class="status-circle"></div>
                <span>촬영,녹음</span>
            </div>
        </div>

        <div class="notice-block">
            <h2>도마동축제에 대한 설명이 여기에 들어갑니다.</h2>
            <p id="showDescription"></p>
        </div>

        <div class="team-info" id="teamInfo">
            <h3>방송콘텐츠제작과</h3>
            <p id="teamDetails"></p>
        </div>

        <div class="cardnews-container">
            <div class="cardnews-navigation">
                <button class="btn" onclick="prevSlide()">←</button>
                <span>카드뉴스</span>
                <button class="btn" onclick="nextSlide()">→</button>
            </div>
            <div id="cardnewsDisplay"></div>
        </div>

        <div class="bottom-buttons">
            <button class="btn" onclick="location.href='https://mytwice.github.io/DIMAART/'">목록으로</button>
            <button class="btn" onclick="sharePerformance()">공유하기</button>
        </div>
    </div>

    <script>
        let currentShow = {};
        let currentCardNewsIndex = 0;

        function getShowNameFromUrl() {
            const path = window.location.pathname;
            return decodeURIComponent(path.substring(path.lastIndexOf('/') + 1));
        }

        function initializePage() {
            const myKey = "1HARkehL11DD1-92_XO6ypNRKqkpayO-Rf4kKuViCLbU"; // 스프레드시트 키
            const query = new google.visualization.Query(
                `https://spreadsheets.google.com/tq?key=${myKey}&pub=1`
            );
            
            query.send(handleQueryResponse);
        }

        function handleQueryResponse(response) {
            if (response.isError()) {
                console.error("Error in query:", response.getMessage());
                return;
            }

            const data = JSON.parse(response.getDataTable().toJSON());
            const showName = getShowNameFromUrl();
            const showData = findShowData(data, showName);
            
            if (showData) {
                currentShow = showData;
                updateUI(showData);
            } else {
                alert("공연 정보를 찾을 수 없습니다.");
            }
        }

        function findShowData(data, showName) {
            const cols = data.cols.map(col => col.label);
            let showData = null;

            data.rows.forEach(row => {
                const rowData = {};
                row.c.forEach((cell, index) => {
                    if (cell) {
                        rowData[cols[index]] = cell.v;
                    }
                });

                if (rowData['표시 ON/OFF'] === 'TRUE' && rowData['공연명'] === showName) {
                    showData = rowData;
                }
            });

            return showData;
        }

        function updateUI(data) {
            // 기본 정보 업데이트
            document.getElementById('mainPoster').src = data['메인포스터'];
            document.getElementById('showTitle').textContent = data['공연명'];
            document.getElementById('showDate').textContent = `${data['일시']} ${data['시간']}`;
            document.getElementById('showVenue').textContent = data['장소'];
            document.getElementById('showCast').textContent = data['출연'];
            document.getElementById('showOrganizer').textContent = data['주최/주관'];
            document.getElementById('showDescription').textContent = data['설명'];
            
            // 상태 표시 업데이트
            updateStatusCircles(data);
            // D-day 업데이트
            updateDDay(data['일시']);
            // 카드뉴스 초기화
            initializeCardNews(data);
        }

        function updateStatusCircles(data) {
            document.getElementById('statusEntry').classList.toggle('status-active', data['입장방식'] === '사전예매');
            document.getElementById('statusTime').classList.toggle('status-active', data['입장오픈'] === 'TRUE');
            document.getElementById('statusNotice').classList.toggle('status-active', data['관람유의여부'] === 'TRUE');
            document.getElementById('statusPhoto').classList.toggle('status-active', data['촬영녹음여부'] === 'TRUE');
        }

        function updateDDay(dateString) {
            const eventDate = new Date(dateString);
            const today = new Date();
            const diffTime = eventDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            document.getElementById('dDay').textContent = `D-${Math.abs(diffDays)}`;
        }

        function initializeCardNews(data) {
            const cardNews = [
                data['카드뉴스1'],
                data['카드뉴스2'],
                data['카드뉴스3'],
                data['카드뉴스4']
            ].filter(url => url);

            if (cardNews.length > 0) {
                const display = document.getElementById('cardnewsDisplay');
                display.innerHTML = `<img src="${cardNews[0]}" style="max-width: 100%; height: auto;">`;
            }
        }

        function prevSlide() {
            if (currentCardNewsIndex > 0) {
                currentCardNewsIndex--;
                updateCardNewsDisplay();
            }
        }

        function nextSlide() {
            const cardNews = [
                currentShow['카드뉴스1'],
                currentShow['카드뉴스2'],
                currentShow['카드뉴스3'],
                currentShow['카드뉴스4']
            ].filter(url => url);

            if (currentCardNewsIndex < cardNews.length - 1) {
                currentCardNewsIndex++;
                updateCardNewsDisplay();
            }
        }

        function updateCardNewsDisplay() {
            const cardNews = [
                currentShow['카드뉴스1'],
                currentShow['카드뉴스2'],
                currentShow['카드뉴스3'],
                currentShow['카드뉴스4']
            ].filter(url => url);

            document.getElementById('cardnewsDisplay').innerHTML = 
                `<img src="${cardNews[currentCardNewsIndex]}" style="max-width: 100%; height: auto;">`;
        }

        function sharePerformance() {
            if (navigator.share) {
                navigator.share({
                    title: currentShow['공연명'],
                    text: `${currentShow['공연명']} 공연 정보를 확인해보세요!`,
                    url: window.location.href
                }).catch(console.error);
            } else {
                const dummy = document.createElement('textarea');
                document.body.appendChild(dummy);
                dummy.value = window.location.href;
                dummy.select();
                document.execCommand('copy');
                document.body.removeChild(dummy);
                alert('공연 정보 링크가 복사되었습니다.');
            }
        }

        google.charts.load("current", { packages: ["corechart"] });
        google.charts.setOnLoadCallback(initializePage);
    </script>
</body>
</html>
